-- 喵喵脚本中心 v1.0 - 可注入版本
-- 修复了原始脚本的兼容性问题

getgenv().MiaoMiao = {
    Version = "1.0",
    Loaded = false,
    Config = {
        AutoLoad = true,
        Notifications = true
    }
}

-- 安全加载函数
local function SafeLoadMiaoMiao()
    if getgenv().MiaoMiao.Loaded then
        return warn("🐱 喵喵脚本已经加载!")
    end
    
    -- 等待游戏加载
    if not game:IsLoaded() then
        game.Loaded:Wait()
    end
    
    -- 等待玩家
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    while not LocalPlayer do
        wait(1)
        LocalPlayer = Players.LocalPlayer
    end
    
    -- 显示加载通知
    if getgenv().MiaoMiao.Config.Notifications then
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "喵喵脚本",
            Text = "正在加载 v1.0...",
            Duration = 3
        })
    end
    
    print("🚀 开始加载喵喵脚本中心 v1.0...")
    
    -- 这里应该是你的主要脚本内容
    -- 由于原始脚本内容未知，我创建一个基础框架
    
    -- 创建主界面函数
    local function CreateMainInterface()
        -- 创建屏幕GUI
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "MiaoMiaoMainUI"
        ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        ScreenGui.Parent = game:GetService("CoreGui")
        
        -- 主窗口
        local MainFrame = Instance.new("Frame")
        MainFrame.Size = UDim2.new(0, 400, 0, 300)
        MainFrame.Position = UDim2.new(0.5, -200, 0.5, -150)
        MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        MainFrame.BorderSizePixel = 0
        MainFrame.Parent = ScreenGui
        
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 8)
        UICorner.Parent = MainFrame
        
        -- 标题栏
        local TitleBar = Instance.new("Frame")
        TitleBar.Size = UDim2.new(1, 0, 0, 40)
        TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        TitleBar.Parent = MainFrame
        
        local TitleLabel = Instance.new("TextLabel")
        TitleLabel.Size = UDim2.new(0, 200, 1, 0)
        TitleLabel.Position = UDim2.new(0, 15, 0, 0)
        TitleLabel.BackgroundTransparency = 1
        TitleLabel.Text = "🐱 喵喵脚本中心 v1.0"
        TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        TitleLabel.TextSize = 16
        TitleLabel.Font = Enum.Font.GothamBold
        TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
        TitleLabel.Parent = TitleBar
        
        -- 关闭按钮
        local CloseButton = Instance.new("TextButton")
        CloseButton.Size = UDim2.new(0, 30, 0, 30)
        CloseButton.Position = UDim2.new(1, -35, 0, 5)
        CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
        CloseButton.Text = "×"
        CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        CloseButton.TextSize = 20
        CloseButton.Font = Enum.Font.GothamBold
        CloseButton.Parent = TitleBar
        
        local CloseCorner = Instance.new("UICorner")
        CloseCorner.CornerRadius = UDim.new(0, 6)
        CloseCorner.Parent = CloseButton
        
        -- 内容区域
        local ContentFrame = Instance.new("ScrollingFrame")
        ContentFrame.Size = UDim2.new(1, -20, 1, -60)
        ContentFrame.Position = UDim2.new(0, 10, 0, 50)
        ContentFrame.BackgroundTransparency = 1
        ContentFrame.ScrollBarThickness = 3
        ContentFrame.Parent = MainFrame
        
        local UIListLayout = Instance.new("UIListLayout")
        UIListLayout.Padding = UDim.new(0, 10)
        UIListLayout.Parent = ContentFrame
        
        -- 添加功能按钮
        local function CreateButton(text, callback)
            local Button = Instance.new("TextButton")
            Button.Size = UDim2.new(1, 0, 0, 40)
            Button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            Button.Text = text
            Button.TextColor3 = Color3.fromRGB(255, 255, 255)
            Button.TextSize = 14
            Button.Font = Enum.Font.Gotham
            Button.Parent = ContentFrame
            
            local ButtonCorner = Instance.new("UICorner")
            ButtonCorner.CornerRadius = UDim.new(0, 6)
            ButtonCorner.Parent = Button
            
            Button.MouseButton1Click:Connect(callback)
            return Button
        end
        
        -- 示例功能按钮
        CreateButton("自动农场", function()
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "喵喵脚本",
                Text = "自动农场功能启动",
                Duration = 3
            })
        end)
        
        CreateButton("玩家传送", function()
            local player = game.Players.LocalPlayer
            if player.Character then
                local hrp = player.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.CFrame = CFrame.new(0, 50, 0)
                end
            end
        end)
        
        CreateButton("复制游戏ID", function()
            setclipboard(tostring(game.PlaceId))
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "信息",
                Text = "游戏ID已复制!",
                Duration = 2
            })
        end)
        
        CreateButton("关闭界面", function()
            ScreenGui:Destroy()
        end)
        
        -- 关闭按钮事件
        CloseButton.MouseButton1Click:Connect(function()
            ScreenGui:Destroy()
        end)
        
        -- 窗口拖动
        local dragging, dragStart, startPos
        TitleBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = MainFrame.Position
            end
        end)
        
        game:GetService("UserInputService").InputChanged:Connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local delta = input.Position - dragStart
                MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
        
        TitleBar.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        print("✅ 喵喵脚本界面创建完成!")
        return ScreenGui
    end
    
    -- 执行主要功能
    local success, err = pcall(function()
        -- 创建主界面
        getgenv().MiaoMiaoUI = CreateMainInterface()
        
        -- 标记为已加载
        getgenv().MiaoMiao.Loaded = true
        
        -- 显示成功通知
        if getgenv().MiaoMiao.Config.Notifications then
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "喵喵脚本",
                Text = "v1.0 加载成功!",
                Duration = 3
            })
        end
        
        print("🎉 喵喵脚本中心 v1.0 加载完成!")
    end)
    
    if not success then
        warn("❌ 喵喵脚本加载失败: " .. tostring(err))
        if getgenv().MiaoMiao.Config.Notifications then
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "喵喵脚本",
                Text = "加载失败: " .. tostring(err),
                Duration = 5
            })
        end
    end
end

-- 自动加载
if getgenv().MiaoMiao.Config.AutoLoad then
    spawn(SafeLoadMiaoMiao)
else
    -- 手动加载函数
    getgenv().LoadMiaoMiao = SafeLoadMiaoMiao
    print("💡 输入 LoadMiaoMiao() 来手动加载喵喵脚本")
end

-- 返回加载状态
return {
    Version = getgenv().MiaoMiao.Version,
    Loaded = getgenv().MiaoMiao.Loaded,
    Load = SafeLoadMiaoMiao
}
